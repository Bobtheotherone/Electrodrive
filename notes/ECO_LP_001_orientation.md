# ECO-LP-001 Orientation (Phase A)

Scope: verify repository state against ECO-LP-001 background/problem statement without code changes. Sources inspected: `AGENTS.md`, `electrodrive/images/basis.py`, `electrodrive/images/search.py`, `electrodrive/learn/collocation.py`, `electrodrive/core/planar_stratified_reference.py`, tests under `tests/`, diagnostics in `tools/check_three_layer_gate1.py` and `tools/three_layer_capacity.py`, notes (`notes/upgrade_phaseA_repo_audit.md`, `notes/phaseF_three_layer_capacity.md`), and run artifacts in `runs/three_layer_highcontrast_region1/`.

## Background confirmations (per scope item)
- **Geometry-aware three_layer_images basis** – `electrodrive/images/basis.py` activates when `BCs="dielectric_interfaces"` with exactly 3 dielectric layers; candidate depths grouped as `three_layer_mirror`, `three_layer_slab`, `three_layer_tail` motifs (z mirrors ± ladder, slab interior fractions, tail below slab). Tests `tests/test_images_three_layer_basis.py` validate depth set/grouping and ensure basis is inactive when the stack is broken.
- **Operator/ISTA conditioning** – `BasisOperator` caches column norms/inverse norms (`estimate_col_norms`, `inv_col_norms`) and supports row weights. `solve_l1_ista` uses normalized matvec/rmatvec for operator and dense modes, logs `basis_operator_stats` (col_norm_min/max, K, N) and ISTA convergence stats. Tests `tests/test_images_ista_operator_conditioning.py` cover dense vs operator parity, ill-scaled columns (1e6), and zero-column safety.
- **Layered collocation & analytic** – `electrodrive/learn/collocation.py` infers `geom="layered_planar"` when dielectrics exist; layered sampling focuses x/y (alpha=0.25) and allocates z around shared interfaces plus all three regions (no z≥0 clamp). Analytic shortcut in `_solve_analytic` builds `ThreeLayerConfig` and uses `potential_three_layer_region1` (region1 Sommerfeld integral) from `electrodrive/core/planar_stratified_reference.py`; `tests/test_layered_collocation.py` compare analytic vs BEM on region1 points, and enforce interface-centric z coverage.
- **Subtract-physical plumbing** – CLI flag (`electrodrive/tools/images_discover.py`) flows to `discover_images` and into `get_collocation_data` (`electrodrive/images/search.py`). Implementation subtracts a free-space point-charge reference only; layered/homogeneous-eps1 subtraction is not present. `tests/test_subtract_physical.py` covers plane induced-only reconstruction and layered smoke (finiteness bound).
- **Diagnostics tooling** – `tools/check_three_layer_gate1.py` and `tools/three_layer_capacity.py` exist; both report absolute MAE/max and boundary stats only (no relative metrics yet). Capacity tool supports optional per-family scaling; Gate 1 tool respects subtract-physical flag when fetching targets.
- **Observed failures** – Run artifacts confirm high-contrast failure: `runs/three_layer_highcontrast_region1/v1` logs `col_norm_max≈5.45e10`, ISTA non-convergent, Gate 1 analytic check MAE≈2.28e2/boundary MAE≈2.40e2. Subtract-physical rerun `v2_subtractphysical` still shows `col_norm_max≈4.28e10`, ISTA stagnation, and huge errors (MAE≈8.2e8). Dense LS capacity (`notes/phaseF_three_layer_capacity.md` via `tools/three_layer_capacity.py`) shows MAE O(1e7–1e12) and column norms O(1e9–1e10) for both moderate (eps2=4, h=0.3) and high contrast (eps2=80, h=0.4); family scaling worsens results.

## Problem framing confirmations
- **Dictionary scaling/conditioning** – Column norms for layered dictionaries sit at 1e9–1e10 before solving (confirmed in runs above and capacity diagnostics). ISTA normalization masks but does not fix scaling; LS remains ill-conditioned.
- **Basis expressiveness** – Current candidate set (`axis_point + three_layer_images`, ~32 candidates, `nmax=12`) lacks complex/depth-exp decays; discovered systems show duplicated real-depth points and spurious far depths (runs/v1, v2_subtractphysical). Dense LS failures on moderate contrast indicate structural inadequacy beyond conditioning.
- **Physical subtraction for layered media** – Subtract-physical path removes only free-space source; no layered/homogeneous-eps1 reference, so dynamic range reduction is weak for slabs (confirmed in `get_collocation_data` and v2_subtractphysical report).
- **Evaluation semantics/metrics** – Diagnostics rely on absolute MAE/max and boundary variants; relative metrics are absent in Gate 1 and capacity tools, making scale-normalized interpretation difficult.
- **Non-discovery classification** – No capacity gate implemented; scripts surface raw errors/col norms but no thresholds or classifications. High errors despite dense LS suggest basis-incapable regimes are not flagged.

## Noted discrepancies/updates
- The older Phase-A audit mentioned a z≥0 clamp for layered collocation; current `_sample_points_for_spec` samples symmetrically across interfaces with interface-focused bands (alpha=0.25), so the clamp is gone.
- Analytic three-layer shortcut is labeled “region1” but is evaluated on all sampled points without an explicit validity mask; tests compare analytic vs BEM only on region1, so using analytic below the slab would be outside its intended validity.
- Subtract-physical remains free-space only; no evidence of layered reference subtraction in code or tests.

## Ready for Phase B
- ECO-LP-001 scope/goals ingested and matched to current repo state. Background and problem statements are confirmed against code, tests, notes, and run artifacts. Ready to proceed to Phase B (relative metrics in diagnostics).
